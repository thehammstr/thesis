% !TEX root = ../Thesis.tex

\chapter{Mapping Results}
\label{ch.Results}

The following sections show GraphSLAM results from simulation and field data. For the former, data was generated by simulating an AUV driving around a model of a real iceberg obtained via ship-based survey. Motion was applied to the model to approximate the effects of wind and current on drift.

In order to validate the method on field data, the near-vertical wall of an underwater canyon in Monterey Bay was used. Navigation data was corrupted before applying the method to demonstrate the algorithm's ability to account for motion-induced warping.

\section{Iceberg Profiling Simulation}

\subsection{Data Generation}

A simulation environment was created in MATLAB to enable mapping results to be compared with known ``truth" for validation of the method. A screen capture from this environment is shown in Figure \ref{fig:IcebergSim}.
 
 \begin{figure}[!htb]
   \centering
   \includegraphics[width=.7\textwidth]{../graphics/ceresResults/SimData/RealIceberg1/SimImage1.png} % requires the graphicx package
   \caption{Screen capture from the iceberg mapping simulation environment. The model was built from data collected from a real iceberg, part of the CNRC iceberg shapes and sightings database. The yellow cylinder represents the multibeam sonar-equipped AUV. The red contour is the current multibeam scan, and the cyan portion represents past scans. Returns are recorded up to the water line. The simulation allows the iceberg to be set adrift with arbitrary motion, and allows the reconstruction to be compared to truth data.}
   \label{fig:IcebergSim}
\end{figure}

A mesh was created based on 3D point cloud data of a real iceberg obtained from the CNRC Iceberg Shapes and Sightings database \cite{Verbit2006}. This particular iceberg was roughly 150 meters long at the waterline, with a keel depth of about 70 meters.

This mesh was set adrift with known translation and rotation. The simulated AUV then flew a helical path of increasing depth around the iceberg, in wall-following mode. Its feedback controller attempted to maintain a constant standoff distance as measured by the two forward-inclined DVL beams.

Multibeam sonar range returns were then generated via ray-tracing on the mesh. These measurements could be corrupted with random noise to simulate imperfect real-world sensing. 

Simulations were run at 30 m and 50 m standoff distance. The latter was used to check robustness of the method to DVL dropouts. When operated at greater standoff distance, the two forward DVL beams often lost contact with the iceberg surface. In these instances, the simulated DVL reported ``MAX RANGE" to the controller and was unable to estimate the full iceberg-relative velocity. To handle these incidents, the wall-following feedback controller saturated its output to gracefully re-acquire the wall. 

In the mapping phase, the dropouts in measured velocity were interpolated between times when the vehicle had good velocity readings. The process noise during these outages was increased to reflect this. The AUV nominally travels at a constant velocity as expressed in the body frame, so these outages did not have a great effect on the end reconstruction.

\subsection{Loop Closure}

The resolution of the simulated iceberg model was insufficient for automatic loop closure detection. The simulated sonar returns were generated from a model that had already been smoothed from raw data, so there was not enough small-scale texture to detect pseudo-image features. The model's smoothness precluded the use of the image feature-based approach to loop closure, as there was insufficient texture to calculate any stable features. As a result only the manual correspondence detection GUI was used for the simulated data. 

The simulation data optimization contained roughly 15 loop closure events. These can be seen in Figure \ref{fig:RawNav}. The green lines represent the offset between two poses, calculated by aligning submaps through ICP. If there were no odometry drift, the ends of each green line would lie on the poses (magenta) used in the loop closure event. However, the iceberg's motion induces apparent drift, so there are errors in the alignment, shown in red.

 \begin{figure}[!htb]
   \centering
   \includegraphics[width=.9\textwidth]{../graphics/ceresResults/SimData/RealIceberg1/RawNav.png} % requires the graphicx package
   \caption{The raw inertial navigation of the AUV during the simulated mapping run is shown by the pink contour. The iceberg's motion causes the large misalignments apparent in the projected multibeam measurements. The green line segments represent calculated loop closure events, provided in pre-processing using a semi-supervised scan matching method. In an accurate map, both ends of each segment should lie on the pink contour.}
   \label{fig:RawNav}
\end{figure}

\subsection{Optimization results}

\subsubsection{Thirty-meter standoff distance}

After one iteration of the Ceres solver, the incorporation of the DVL velocity data eliminates essentially all of the effects of translational drift.  However, errors associated with the iceberg's rotation manifest in an apparent twisting of the data. This can be seen in Figure \ref{fig:WithDVL1}.

\begin{figure}[!htb]
   \centering
   \includegraphics[width=.9\textwidth]{../graphics/ceresResults/SimData/RealIceberg1/WithDVL2.png} % requires the graphicx package
   \caption{The incorporation of iceberg-facing DVL readings corrects for iceberg translation effects, but cannot resolve changes in the iceberg's heading. This results in a ``corkscrew effect" error pattern, where the reprojected multibeam data appear to twist about the iceberg center.}
   \label{fig:WithDVL1}
\end{figure}

Further iterations reduce this error, yielding the final reconstructed cloud and trajectory estimate shown in Figure \ref{fig:FullSimSol}.

 \begin{figure}[!htb]
   \centering
   \includegraphics[width=.9\textwidth]{../graphics/ceresResults/SimData/RealIceberg1/FullSolution.png} % requires the graphicx package
   \caption{After processing the data with GraphSLAM, the remaining alignment error is eliminated. In the process of aligning the point clouds, dead-reckoned DVL errors are estimated along with the errors related to iceberg heading. The output is the the map and trajectory that minimizes the odometry and alignment errors, weighted by the relative uncertainty of each. }
   \label{fig:FullSimSol}
\end{figure}

The 150 meter-long simulated iceberg's keel was reconstructed to an rms accuracy of 0.8 m. For reference, this is of the same order as a typical multibeam sonar at this range ($\pm 1-2\%$ range at 40m). This means that the algorithm was able to recover the iceberg shape to within the accuracy of the sensor, despite large motion uncertainty. 

 \begin{figure}[!htb]
   \centering
   \includegraphics[width=.9\textwidth]{../graphics/rmspoint8.png} % requires the graphicx package
   \caption{The reconstructed keel (blue points) laid over the model. The rms error was measured to be .8m for the roughly 150 meter-long iceberg. Red points mark the center of each face of the model, used to aid the calculation.}
   \label{fig:RMS}
\end{figure}

To compute this accuracy metric, the reconstructed shape was registered against the original model via ICP. For each point in the registered, reconstructed cloud, the distance to the model's nearest surface was recorded. These results are shown in Figure \ref{fig:RMS}. 

The iceberg was simulated to have a constant translational drift rate, and a slow, smoothly time-varying heading rate. Over the course of the mapping run, the rotational velocity started from zero, increased to a maximum, and returned to zero by the end of the run. This was done for validation purposes, to determine how well the algorithm could estimate non-constant-rate rotations. Results of the estimation are shown in Figure \ref{fig:PsiEst}. The larger error at the beginning of the estimation corresponds to the ``acquisition" phase of the simulation, where the AUV starts at a greater distance, approaches, and then begins to track the iceberg at the nominal standoff distance. This maneuver results in less dense data due to greater range and large vehicle yaw rate, making alignment less precise. Otherwise, the estimate shows good agreement with the true value.

 \begin{figure}[!htb]
   \centering
   \includegraphics[width=.8\textwidth]{../graphics/psiVsTimeSim.png} % requires the graphicx package
   \caption{The dashed line is GraphSLAM's estimate of the iceberg's heading rate, $\beta$ for the data shown above. It captures well the iceberg's nonuniform behavior of the rate (smooth curve).}
   \label{fig:PsiEst}
\end{figure}

\subsubsection{Increased Standoff distance}

At an increased standoff distance of 50 meters, the DVL only remained locked in on the iceberg around 40\% of the time, yielding less precise odometry. Despite this, the mapping algorithm was able to correct for the iceberg's motion.

 \begin{figure}[!htb]
   \centering
   \includegraphics[width=.8\textwidth]{../graphics/ceresResults/SimData/RealIceberg1/50m_standoff/reconstruction_50m_standoff.png} % requires the graphicx package
   \caption{At 50m standoff distance, the vehicle was out of DVL velocity lock roughly 60\% of the time. In spite of this, the algorithm was able to recover and produce a self-consistent map.}
   \label{fig:FullSim50m}
\end{figure}


%----------------------------------------------------------------------------
\clearpage
\section{Soquel Canyon Wall Data}

\subsection{Data Collection}

Data was collected in October 2012 from a vertical-walled portion of Soquel Canyon, an underwater canyon in Monterey Bay. The location of this canyon is shown in Figure \ref{fig:SoquelLoc}, with corresponding bathymetry shown in Figure \ref{fig:SoquelBathy}. The portion of the canyon that was traversed is roughly 1.5 km in length. The vehicle flew three passes next to the wall with two return legs, shown in black, highlighted with the red box in Figure \ref{fig:SoquelBathy}.

 \begin{figure}[!htb]
   \centering
   \includegraphics[width=.9\textwidth]{../graphics/SoquelLoc.png} % requires the graphicx package
   \caption{Canyon wall test site location}
   \label{fig:SoquelLoc}
\end{figure}

 \begin{figure}[!htb]
   \centering
   \includegraphics[width=.9\textwidth]{../graphics/SoquelBathymetry.jpg} % requires the graphicx package
   \caption{Bathymetry map of Soquel and Monterey Canyon}
   \label{fig:SoquelBathy}
\end{figure}

In order to approximate the effects of iceberg drift on the static canyon data, the navigation data was corrupted with a heading rate error. 

\subsection{Results from Automatic Loop Closure}

The automatic loop closure detection scheme detailed in Chapter \ref{ch.LoopClosure} was applied to the Soquel Canyon wall dataset. In order to prevent false matches from being detected, a high threshold was used on the automated loop closure detection algorithm. This required six additional SIFT features to agree with the four used for creating the homography used in RANSAC, for a total of 10 RANSAC inliers. As a result, only two loop closure events were identified with high enough confidence to add them to the optimization.  One of these pairs of matching range images is shown in Figure \ref{fig:autoLC}, and the locations of the links can be seen in red in the upper left corner of Figure \ref{fig:RealDataWithDrift}.

 \begin{figure}[!htb]
   \centering
   \includegraphics[width=.9\textwidth]{../graphics/siftMatches.png} % requires the graphicx package
   \caption{A loop closure event detected automatically by the method described in Chapter \ref{ch.LoopClosure}}
   \label{fig:autoLC}
\end{figure}

 \begin{figure}[!htb]
   \centering
   \includegraphics[width=.9\textwidth]{../graphics/ceresResults/CanyonData/rawNav_20degPerHour.png} % requires the graphicx package
   \caption{Data collected by an AUV in a portion of Monterey Canyon with near-vertical walls. The navigation data was corrupted with a heading error to simulate the effects of iceberg motion. This instance corresponds to a drift rate of 20 deg/hr. The resulting large dead reckoned drift complicates the task of detecting loop closure.}
   \label{fig:RealDataWithDrift}
\end{figure}

Despite only having two loop closures, GraphSLAM was able to correct most of the navigation errors. The results of this are shown in Figure \ref{fig:AutoSol}. The self-consistency of the data is very good near the loop closure events, as seen in Figure \ref{fig:AutoSol1}. Farther away from these links, however, some double-wall artifacts, or ``ghosting" exist. This is a result of navigation errors causing sonar data to misalign. The magnitude of these errors is around 5m, or 0.3\% of distance traveled, which is similar to the performance of dead reckoning with uncorrupted navigation data. One instance of this effect is shown in Figure \ref{fig:AutoSol2}, highlighted with a red box. This is consistent with expectations, since the solution has to rely on odometry, with all its associated drift error, for position estimation in areas where loop closures were not detected. 

 \begin{figure}[!htb]
   \centering
   \includegraphics[width=.9\textwidth]{../graphics/ceresResults/CanyonData/AutomatedLoopClosure/AutomatedSolution.png} % requires the graphicx package
   \caption{Solution generated with only two loop closures, detected by the method described in Chapter \ref{ch.LoopClosure}.}
   \label{fig:AutoSol}
\end{figure}

 \begin{figure}[!htb]
   \centering
   \includegraphics[width=.9\textwidth]{../graphics/ceresResults/CanyonData/AutomatedLoopClosure/AutomatedSolutionDetail.png} % requires the graphicx package
   \caption{The map near the loop closure events is self-consistent.}
   \label{fig:AutoSol1}
\end{figure}

 \begin{figure}[!htb]
   \centering
   \includegraphics[width=.9\textwidth]{../graphics/ceresResults/CanyonData/AutomatedLoopClosure/AutomatedSolutionErrors.png} % requires the graphicx package
   \caption{Top view of the map far from the loop closure events, highlighting inconsistencies. Here, the two passes by the wall have several meters' misalignment.}
   \label{fig:AutoSol2}
\end{figure}

\subsection{Refinement via Manually-assisted Loop Closure}

This automatic loop closure detection was able to account for nearly all of the motion-induced error in the navigation data, yielding a trajectory estimate of roughly the same accuracy as those obtained by dead reckoning with a high-precision inertial navigation system and DVL. 

Using this as a starting point, distance-based heuristics like those used in MB-system \cite{Caress2006} could have been used to detect more loop closures. Instead, the GUI described in Chapter \ref{ch.LoopClosure} and \ref{ap.GUI} was used. An additional 23 loop closure events were detected, yielding 25 events in total. With the data already nearly aligned perfectly from the automated procedure, this was a simple exercise. These additional links can be seen in Figure \ref{fig:RealDataSolution1}, shown as bright green lines between points on the magenta trajectory.

 \begin{figure}[!htb]
   \centering
   \includegraphics[width=.9\textwidth]{../graphics/ceresResults/CanyonData/ThreePassConvergence.png} % requires the graphicx package
   \caption{After processing with additional loop closures, the inconsistencies are eliminated. Three swaths of data collected at different depths are fused into one self-consistent map. }
   \label{fig:RealDataSolution1}
\end{figure}

The results of this refinement are shown in Figures \ref{fig:RealDataSolution1}, \ref{fig:RealDataSolution2}, and \ref{fig:RealDataSolution3}. The sonar data is self-consistent, showing no discernible ghosting or other artifacts of misalignment.

This is especially clear in Figure \ref{fig:RealDataSolution4}, where the addition of links have eliminated the errors highlighted in Figure \ref{fig:AutoSol2}.


 \begin{figure}[!htb]
   \centering
   \includegraphics[width=.9\textwidth]{../graphics/ceresResults/CanyonData/ThreePassConvergence1.png} % requires the graphicx package
   \caption{Detailed view of the SLAM reconstruction, highlighting the multiple swaths of data fused into a self-consistent map. As in the simulated data, the pink contour is the AUV trajectory estimate, and the green segments show pre-processed loop closure events. }
   \label{fig:RealDataSolution2}
\end{figure}

 \begin{figure}[!htb]
   \centering
   \includegraphics[width=.9\textwidth]{../graphics/ceresResults/CanyonData/ThreePassConvergence2.png} % requires the graphicx package
   \caption{Detailed view of the SLAM reconstruction, highlighting the multiple swaths of data fused into a self-consistent map. }
   \label{fig:RealDataSolution3}
\end{figure}

 \begin{figure}[!htb]
   \centering
   \includegraphics[width=.9\textwidth]{../graphics/ceresResults/images/LinksTopView.png} % requires the graphicx package
   \caption{The inconsistency from the automated solution is removed with the inclusion of additional loop closure events.}
   \label{fig:RealDataSolution4}
\end{figure}

Finally, Figure \ref{fig:RealDataSolution5} gives an end-on view of the canyon, showing again that the data is self-consistent, and the loop closure constraints have been satisfied (each end of the green line lies on a magenta point).

 \begin{figure}[!htb]
   \centering
   \includegraphics[width=\textwidth]{../graphics/ceresResults/images/LowAngle.png} % requires the graphicx package
   \caption{Looking up the reconstructed canyon.}
   \label{fig:RealDataSolution5}
\end{figure}
\subsection{Soquel Canyon Results}


\section{Summary}

Mapping results were shown for both simulated iceberg data and field data collected in an underwater canyon with motion added to simulate that of an iceberg. 

For the simulated iceberg, the human-in-the-loop loop closure detection procedure was used. GraphSLAM was then performed, and the keel was reconstructed to 0.8 meters rms accuracy, which is on the order of the ranging error of the sensors typically used to create these maps at the corresponding standoff distances. The algorithms also produced an accurate estimate of the iceberg's heading rate during the course of the mapping run.

For the experimental data, automatic loop closure detection procedures were able to generate a trajectory estimate on the order of high-precision dead reckoning through static terrain, which was further refined with additional manually-detected loop closures.  While no truth data was available for shape comparison, the map was qualitatively self-consistent. Therefore the algorithm was demonstrated on field data to be robust to large motion errors consistent with those induced by iceberg motion.


